<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<!-- <th:block th:replace="~{/nav}"></th:block> -->
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<script
	src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
<style>
/* ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ì˜ì—­ì˜ ìŠ¤íƒ€ì¼ */
		.container{
			overflow-x: auto;
		}
        .table-container {
            max-height: 20em; /* ì›í•˜ëŠ” ë†’ì´ë¡œ ì¡°ì ˆ */
            overflow-y: auto; /* ì„¸ë¡œ ìŠ¤í¬ë¡¤ í‘œì‹œ */
        }

        /* ê³ ì •ëœ í…Œì´ë¸” í—¤ë” ìŠ¤íƒ€ì¼ */
        .fixed-header {
            position: sticky;
            top: 0;
            background-color: white;
            z-index: 1;
        }
		.code-group-id-text:hover {
		    cursor: pointer;
		}
</style>
</head>
<body>
	<div id="wrapper">
		<div id="commonCode">
			<div class="container">
				<h2>ê³µí†µ ì½”ë“œ</h2>
				<p>* ê³µí†µ ì½”ë“œ ê´€ë¦¬</p>
				<span>ì‚¬ìš© ì—¬ë¶€</span> 
					<select id="commonCodeUseYn">
						<option value="A" checked="checked">ì „ì²´</option>
						<option value="Y">Y</option>
						<option value="N">N</option>
					</select> 
				<span>ì½”ë“œ ê·¸ë£¹ëª… ë° ID</span> <input name="commonCodeKeyword" type="text" placeholder="ê³µí†µ ì½”ë“œ ë° ê·¸ë£¹ ID ì…ë ¥">
				<input id="searchCommonCodeBtn" type="button" value="ê²€ìƒ‰">
				<div>
					<input id="commonCodeAddRowBtn" type="button" value="í–‰ì¶”ê°€">
					<input id="commonCodeDeleteRowBtn" type="button" value="í–‰ì‚­ì œ">
					<input id="commonCodeSaveBtn" type="button" value="ì €ì¥">
				</div>
				<div class="table-container commoncode-table-container">
					<table class="table table-striped commoncode-table">
						<thead class="fixed-header">
							<tr>
								<th>ìƒíƒœ</th>
								<th>ì½”ë“œ ê·¸ë£¹ ID</th>
								<th>ì½”ë“œ ê·¸ë£¹ëª…</th>
								<th>ìƒì„¸ ì½”ë“œ ê°œìˆ˜</th>
								<th>ì‚¬ìš© ì—¬ë¶€</th>
							</tr>
						</thead>
						<tbody id="commonCode-table-body">
							<tr th:each="commonCode, i : ${commonCode}">
								<td th:text="${commonCode.flag}"></td>
								<td id="commonCode-group-id" class="code-group-id-text" th:text="${commonCode.codeGroupId}" th:data-code-group-id="${commonCode.codeGroupId}"></td>
								<td><input type="text" th:value="${commonCode.codeGroupName}"></td>
								<td th:text="${commonCode.codeDetailCount}"></td>
								<td><select>
										<option th:value="${commonCode.useYn}" th:text="${commonCode.useYn}"></option>
										<option value="N">N</option>
								</select></td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
			<div id="commonCodeDetail">
				<div></div>
				<div class="container">
					<h2>ìƒì„¸ ì½”ë“œ</h2>
					<p>* ìƒì„¸ ì½”ë“œ ê´€ë¦¬</p>
					<span>ì‚¬ìš© ì—¬ë¶€</span> 
						<select id="commonCodeDetailUseYn">
							<option value="A" selected>ì „ì²´</option>
							<option value="Y">Y</option>
							<option value="N">N</option>
						</select> 
					<span>ì½”ë“œ ê·¸ë£¹ëª… ë° ID</span> <input name="commonCodeDetailKeyword" type="text" placeholder="ìƒì„¸ ì½”ë“œ ë° ì½”ë“œëª… ì…ë ¥">
					<input id="searchCommonCodeDetailBtn" type="button" value="ê²€ìƒ‰">
					<div>
						<input id="commonCodeDetailAddRowBtn" type="button" value="í–‰ì¶”ê°€">
						<input id="commonCodeDetailDeleteRowBtn" type="button" value="í–‰ì‚­ì œ">
						<input id="commonCodeDetailSaveBtn" type="button" value="ì €ì¥">
					</div>
					<div class="table-container commoncodedetail-table-container">
						<table class="table table-striped commoncodedetail-table">
							<thead class="fixed-header">
								<tr>
									<th>ìƒíƒœ</th>
									<th>ì„ íƒ</th>
									<th>ìƒì„¸ ì½”ë“œ</th>
									<th>ìƒì„¸ ì½”ë“œëª…</th>
									<th>ì‚¬ìš© ì—¬ë¶€</th>
								</tr>
							</thead>
							<tbody id="commonCodeDetail-table-body">
								<tr th:each="commonCodeDetail, i : ${commonCodeDetail}">
									<td th:text="${commonCodeDetail.flag}"></td>
									<td><input class="detailCheck" type="checkbox" name="detailCheck"></td>
									<td><input type="text" name="detailCode" th:value="${commonCodeDetail.detailCode}"></td>
									<td><input type="text" name="detailCodeName" th:value="${commonCodeDetail.detailCodeName}"></td>
									<td>
									<select>
										<option th:value="${commonCodeDetail.useYn}" th:text="${commonCodeDetail.useYn}"></option>
										<option value="N">N</option>
									</select>
									</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script th:inline="javascript">
		
		$(document)
				.ready(
						function() {
							var commonCode = `[[${commonCode}]]`;
							var commonCodeDetail = `[[${commonCodeDetail}]]`;

							var commonCodeList = JSON.parse(commonCode); // Object Type
							var commonCodeDetail = JSON.parse(commonCodeDetail);
							console.log(commonCodeList[0]);

							// ê³µí†µ ì½”ë“œ í–‰ì¶”ê°€ ë²„íŠ¼
							$("#commonCodeAddRowBtn").click(() => {
								// ìƒˆë¡œìš´ í–‰ ìƒì„±
								var newRow = $("<tr>");
								var status = $("<td>").text("C");
								var codeGroupId = $("<td>").append("<input type='text'>");
								var codeGroupName = $("<td>").append("<input type='text'>");
								var codeDetailCount = $("<td>").text("-");
								var useYn = $("<td>").append("<select><option>Y</option><option>N</option></select>");
								
								newRow.append(status);
								newRow.append(codeGroupId);
								newRow.append(codeGroupName);
								newRow.append(codeDetailCount);
								newRow.append(useYn);

								// í…Œì´ë¸”ì— ìƒˆë¡œìš´ í–‰ ì¶”ê°€
								$(".commoncode-table tbody").append(newRow);

								// í–‰ ì¶”ê°€ ì‹œ ìŠ¤í¬ë¡¤ ë§¨ ì•„ë˜
								var tableContainer = $(".commoncode-table-container");
								tableContainer.scrollTop(tableContainer[0].scrollHeight);
							});

							// ê³µí†µ ì½”ë“œ í–‰ì‚­ì œ ë²„íŠ¼
							$("#commonCodeDeleteRowBtn").click(() => {
								var commonCodeTable = $(".commoncode-table tbody");
								var lastRow = commonCodeTable.find("tr:last");
								const codeGroupId = lastRow.find("#commonCode-group-id").text();
								console.log(codeGroupId);

								$.ajax({
									method : "GET",
									url : "/checkcodegroup?codeGroupId=" + codeGroupId,
									success : function(response) {
										if (response > 0) {
											alert("ì´ ì½”ë“œ ê·¸ë£¹ì€ DBì— ì¡´ì¬í•©ë‹ˆë‹¤. ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
											return;
										} else {
											// ì½”ë“œ ê·¸ë£¹ì´ DBì— ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ í•´ë‹¹ í–‰ì„ ì‚­ì œí•©ë‹ˆë‹¤.
											lastRow.remove();
										}
									},
									error : function(xhr,status,error) {
										alert("ì—ëŸ¬ ë°œìƒ:", error);
									}
								});
							});
							
							// ê³µí†µ ì½”ë“œ í–‰ ë‚´ì˜ ì…ë ¥ í•„ë“œì— ëŒ€í•œ change ì´ë²¤íŠ¸ ì²˜ë¦¬
							$(".commoncode-table-container").on("change", "input[type='text'], select", function(){
							    var changedRow = $(this).closest("tr"); // ë³€ê²½ëœ ì…ë ¥ í•„ë“œë¥¼ í¬í•¨í•˜ëŠ” í–‰ ê°€ì ¸ì˜¤ê¸°
							    var flag = changedRow.find("td:first").text();
								if(flag === "C"){
									return;
								}
							    // ë³€ê²½ ìƒíƒœë¥¼ í‘œì‹œ (ì˜ˆ: C = Created, U = Updated)
							    changedRow.find("td:first").text("U");
							});
							
							// ê³µí†µ ì½”ë“œ ê²€ìƒ‰ 
							$("#searchCommonCodeBtn").click(() => {
								var useYn = $("#commonCodeUseYn option:selected").val();
								var keyword = $("input[name='commonCodeKeyword']").val();
								$.ajax({
									method: "GET",
									url : "/search/commoncode",
									data : {
										useYn: useYn,
										keyword: keyword
									},
									success : function(response) {
										updateCommonCodeTable(response);
									},
									error : function(xhr,status,error) {
										alert("ì—ëŸ¬ ë°œìƒ:", error);
									}
								});
							});
							
							// ê³µí†µ ì½”ë“œ í…Œì´ë¸” ì—…ë°ì´íŠ¸ í•¨ìˆ˜
							function updateCommonCodeTable(response){
								const commonCodeTable = $("#commonCode-table-body tr");
								commonCodeTable.remove();
								
								if(response.length < 1){
									const result = "<tr>" + "<td colspan='5' style='text-align:center; font-weight: bold;'>" 
			                		+ "ê²€ìƒ‰ëœ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤." + "</td>" + "</tr>";
									$("#commonCode-table-body").append(result);
									return;
								}
								
								for(var i=0; i<response.length; i++){
									var newRow = $("<tr>");
									var status = $("<td>").addClass("flag").text(response[i].flag);
									var codeGroupId = $("<td>").addClass("codeGroupId").text(response[i].codeGroupId);
									var codeGroupName = $("<td>").append($("<input>").attr({
										type: "text",
										name: "codeGroupName",
										value: response[i].codeGroupName,
										class: "codeGroupName"
									}));
									var codeDetailCount = $("<td>").addClass("codeDetailCount").text(response[i].codeDetailCount);
									var useYn = $("<td>").append("<select><option>Y</option><option>N</option></select>");
									
									newRow.append(status);
									newRow.append(codeGroupId);
									newRow.append(codeGroupName);
									newRow.append(codeDetailCount);
									newRow.append(useYn);

									$(".commoncode-table tbody").append(newRow);
								}
							}
							
							
							$(".code-group-id-text").click(function() {
							    var codeGroupId = $(this).text();
							    console.log(codeGroupId);
							    $.ajax({
							    	method: "GET",
							    	url : "/commoncodedetail",
							    	data : {
							    		codeGroupId : codeGroupId
							    	},
							    	success : function(response){
							    		updateCommonCodeDetail(response);
							    	},
							    	error : function(xhr, status, error){
							    		alert("ì—ëŸ¬ ë°œìƒ:", error);
							    	}
							    })
							});
							
							// ê³µí†µ ì½”ë“œ ì €ì¥ ë²„íŠ¼
							$("#commonCodeSaveBtn").click(() => {
								
								$.ajax({
									method: "POST",
									url : "/commoncode",
									success : function(response){
										console.log(response.commonCode);
									},
									error : function(xhr,status,error) {
										alert("ì—ëŸ¬ ë°œìƒ:", error);
									}
								})
							})
							
							// ìƒì„¸ ì½”ë“œ í–‰ ì¶”ê°€ ë²„íŠ¼
							$("#commonCodeDetailAddRowBtn").click(() => {
								// ìƒˆë¡œìš´ í–‰ ìƒì„±
								var newRow = $("<tr>");
								var status = $("<td>").text("C");
								var select = $("<td>").append($("<input>").attr({
									type : "checkbox",
									name : "detailCheck",
									class : "detailCheck"
								}));
								var detailCode = $("<td>").append($("<input>").attr({
									type : "text",
									name : "detailCode",
									class : "detailCode"
								}));
								var detailCodeName = $("<td>").append($("<input>").attr({
									type : "text",
									name : "detailCodeName",
									class : "detailCodeName"
								}));
								var useYn = $("<td>").append("<select><option>Y</option><option>N</option></select>");
								
								newRow.append(status);
								newRow.append(select);
								newRow.append(detailCode);
								newRow.append(detailCodeName);
								newRow.append(useYn);
								
								$(".commoncodedetail-table tbody").append(newRow);
								
								var tableContainer = $(".commoncodedetail-table-container");
								tableContainer.scrollTop(tableContainer[0].scrollHeight);
							})

							// ìƒì„¸ ì½”ë“œ í–‰ ì‚­ì œ ë²„íŠ¼
							$("#commonCodeDetailDeleteRowBtn").click(() => {
								var commonCodeTable = $(".commoncodedetail-table");
								var selectedRows = $("input[name='detailCheck']:checked").closest("tr"); // ì„ íƒëœ ì²´í¬ë°•ìŠ¤ì˜ ë¶€ëª¨ í–‰ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
								console.log(selectedRows);

							    if (selectedRows.length === 0) {
							        alert("ì‚­ì œí•  í–‰ì„ ì„ íƒí•˜ì„¸ìš”.");
							        return;
							    }

							    // ì„ íƒëœ ê° í–‰ì— ëŒ€í•´ ì²˜ë¦¬
							    selectedRows.each(function() {
							        var selectedRow = $(this);
							        
							        // ì„ íƒëœ í–‰ì„ ë‘ë²ˆ ëˆ„ë¥¼ ê²½ìš° checkedë˜ ìˆëŠ” ìƒíƒœì´ê¸° ë•Œë¬¸ì— ì„ íƒí•œ í–‰ì´ ì‚­ì œë˜ì—ˆë‹¤ê³  ëœ¨ëŠ” ê²ƒì„ ë§‰ê¸° ìœ„í•´
							        selectedRow.find("input[name='detailCheck']").prop("checked", false);

							        var flag = selectedRow.find("td:first").text();
							        if (flag === "C") {
							            // CreateëŠ” ë°˜ì˜í•˜ì§€ ì•Šìœ¼ë©´ ë˜ë¯€ë¡œ ê·¸ëƒ¥ í–‰ ì‚­ì œ
							            selectedRow.remove();
							        } else {
							            // í–‰ì˜ flagë¥¼ "D"ë¡œ ë³€ê²½
							            selectedRow.find("td:first").text("D");
							        }
							    });
							    alert("ì„ íƒëœ í–‰ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
							    return;
							})
							
							// ìƒì„¸ ì½”ë“œ í–‰ ë‚´ì˜ ì…ë ¥ í•„ë“œì— ëŒ€í•œ change ì´ë²¤íŠ¸ ì²˜ë¦¬
							$(".commoncodedetail-table-container").on("change", "input[type='text'], select", function(){
							    var changedRow = $(this).closest("tr"); // ë³€ê²½ëœ ì…ë ¥ í•„ë“œë¥¼ í¬í•¨í•˜ëŠ” í–‰ ê°€ì ¸ì˜¤ê¸°
							    var flag = changedRow.find("td:first").text();
								if(flag === "C"){
									return;
								}
							    // ë³€ê²½ ìƒíƒœë¥¼ í‘œì‹œ (ì˜ˆ: C = Created, U = Updated)
							    changedRow.find("td:first").text("U");
							});
							
							// ìƒì„¸ ì½”ë“œ ê²€ìƒ‰
							$("#searchCommonCodeDetailBtn").click(() => {
								var useYn = $("#commonCodeDetailUseYn option:selected").val();
								var keyword = $("input[name='commonCodeDetailKeyword']").val();
								console.log(useYn);
								$.ajax({
									method: "GET",
									url : "/search/commoncodedetail",
									data : {
										useYn: useYn,
										keyword: keyword
									},
									success : function(response) {
										for(var i=0; i< response.length; i++){
											response[i].fla
										}
										updateCommonCodeDetail(response);
									},
									error : function(xhr,status,error) {
										alert("ì—ëŸ¬ ë°œìƒ:", error);
									}
								});
							});
							
							// ìƒì„¸ ì½”ë“œ í…Œì´ë¸” ì—…ë°ì´íŠ¸ í•¨ìˆ˜
							function updateCommonCodeDetail(response){
								const commonCodeDetailTable = $("#commonCodeDetail-table-body tr");
								commonCodeDetailTable.remove();
								
								if(response.length < 1){
									const result = "<tr>" + "<td colspan='5' style='text-align:center; font-weight: bold;'>" 
			                		+ "ê²€ìƒ‰ëœ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤." + "</td>" + "</tr>";
									$("#commonCodeDetail-table-body").append(result);
									return;
								}
								
								for (var i = 0; i < response.length; i++) {
									var newRow = $("<tr>");
									var status = $("<td>").text(response[i].flag);
									var select = $("<td>").append($("<input>").attr({
									    type: "checkbox",
									    name: "detailCheck",
									    class: "detailCheck"
									  }));
									var detailCode = $("<td>").append($("<input>").attr({
										type: "text",
										name: "detailCode",
										value: response[i].detailCode,
										class: "detailCode"
									}));
									var detailCodeName = $("<td>").append($("<input>").attr({
										type: "text",
										name: "detailCodeName",
										value: response[i].detailCodeName,
										class: "detailCodeName"
									}));
									var useYn = $("<td>").append("<select><option>Y</option><option>N</option></select>");
									
									newRow.append(status);
									newRow.append(select);
									newRow.append(detailCode);
									newRow.append(detailCodeName);
									newRow.append(useYn);
									$(".commoncodedetail-table tbody").append(newRow);
								}
							}
				});
	</script>
<!--  
	ì´ˆë¡ìƒ‰ ì› ğŸŸ¢
	ë¹¨ê°„ìƒ‰ ì› ğŸ”´
	ë…¸ë€ìƒ‰ ì› ğŸŸ¡
-->
</body>
</html>