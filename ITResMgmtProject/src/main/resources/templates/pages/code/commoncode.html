<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="../common/layout/default">
<head>
<meta charset="UTF-8">
<style>
/* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
.table {
  width: 100%;
  margin: 5px 0;
}
h1{
	font-size: 24px;
    margin-bottom: 0;
    font-weight: 600;
    color: #012970;
}
.table th {
  background-color: #f2f2f2;
  font-weight: bold;
}

.table tr:nth-child(even) {
  background-color: #f2f2f2;
}

/* ë§ˆìš°ìŠ¤ ì˜¤ë²„ íš¨ê³¼ */
.table tr:hover {
  background-color: #e0e0e0;
}
/* ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ì˜ì—­ì˜ ìŠ¤íƒ€ì¼ */
.container {
	overflow-x: auto;
}

#commonCode {
	display: flex;
}

.commoncode-container {
	font-size: 13px;
	padding: 10px;
	border: 1px solid #ccc;
	border-radius: 5px;
	box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.2);
}
.commoncodedetail-container {
	font-size: 13px;
	padding: 10px;
	border: 1px solid #ccc;
	border-radius: 5px;
	box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.2);
}

.table-container {
	max-height: 40em; /* ì›í•˜ëŠ” ë†’ì´ë¡œ ì¡°ì ˆ */
	overflow-y: auto; /* ì„¸ë¡œ ìŠ¤í¬ë¡¤ í‘œì‹œ */
}

/* ê³ ì •ëœ í…Œì´ë¸” í—¤ë” ìŠ¤íƒ€ì¼ */
.fixed-header {
	position: sticky;
	top: 0;
	background-color: white;
	z-index: 1;
}

.search-info-container {
	margin: 20px 5px 10px 0;
	justify-content: center; /* ê°€ë¡œ ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•´ ì¶”ê°€ */
  	align-items: center; /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•´ ì¶”ê°€ */
}
.search-detail-info{
	padding: 10px;
	border: 1px solid #ccc;
	border-radius: 5px;
	box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.2);
}
.common-btn-container {
	margin-left: auto;
	text-align: right;
}

.row-btn {
	text-align: right;
}

/* ì…ë ¥ë€ ìŠ¤íƒ€ì¼ */
input[type="text"] {
	margin: 2px;
	padding: 2px;
	border: 1px solid #ccc;
	border-radius: 5px;
	font-size: 12px;
	outline: none;
}

.code-group-id-input{
	width: 40%;	
}

/* ì„ íƒ ìƒì ìŠ¤íƒ€ì¼ */
select {
	margin: 2px;
	padding: 2px;
	border: 1px solid #ccc;
	border-radius: 5px;
	font-size: 12px;
	outline: none;
}

/* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
input[type="button"] {
	padding: 5px 5px;
	background-color: #007BFF;
	color: #fff;
	border: none;
	border-radius: 5px;
	font-size: 14px;
	cursor: pointer;
}
</style>
<link th:href="@{/css/resclass/menutree.css}" rel="stylesheet" />
</head>
<th:block layout:fragment="content">
<main id="main" class="main">
	<h1>ê³µí†µ ì½”ë“œ</h1>
      <nav>
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a th:href="@{/}">Home</a></li>
          <li class="breadcrumb-item active">ê³µí†µ ì½”ë“œ</li>
        </ol>
      </nav>
	<div id="commonCode">
		<div class="container commoncode-container">
			<!-- <div>
					ğŸŸ¢ ê¸°ì¡´ ì½”ë“œ
					ğŸŸ¡ ìˆ˜ì • 
					ğŸ”µ ìƒì„±
					ğŸ”´ ì‚­ì œ
				</div> -->
			<h1>ê³µí†µ ì½”ë“œ</h1>
			<div class="common-btn-container">
				<input id="searchCommonCodeBtn" type="button" value="ì¡°íšŒ"> <input id="commonCodeSaveBtn" type="button" value="ì €ì¥">
			</div>
			<div class="search-info-container">
				<div class="search-detail-info">
					<span>ì‚¬ìš© ì—¬ë¶€</span> <select id="commonCodeUseYn">
						<option value="A">ì „ì²´</option>
						<option value="Y">Y</option>
						<option value="N">N</option>
					</select> <span>ì½”ë“œ ê·¸ë£¹</span> <input name="commonCodeKeyword"
						type="text" placeholder="ID ë° ê·¸ë£¹ëª…">
				</div>
			</div>
			<div class="row-btn">
				<input id="commonCodeAddRowBtn" type="button" value="í–‰ì¶”ê°€"> <input
					id="commonCodeDeleteRowBtn" type="button" value="í–‰ì‚­ì œ">
			</div>
			<div class="table-container commoncode-table-container">
				<table class="table table-striped commoncode-table">
					<thead class="fixed-header">
						<tr>
							<th>ìƒíƒœ</th>
							<th>ì½”ë“œ ê·¸ë£¹ ID</th>
							<th>ì½”ë“œ ê·¸ë£¹ëª…</th>
							<th>ìƒì„¸ ì½”ë“œ ê°œìˆ˜</th>
							<th>ì‚¬ìš© ì—¬ë¶€</th>
							<th>ì¡°íšŒ</th>
						</tr>
					</thead>
					<tbody id="commonCode-table-body">
						<tr th:each="commonCode, i : ${commonCode}">
							<td th:text="${commonCode.flag}"></td>
							<td id="commonCode-group-id"
								class="code-group-td code-group-id-text"
								th:text="${commonCode.codeGroupId}"
								th:data-code-group-id="${commonCode.codeGroupId}"></td>
							<td><input id="commonCode-group-name"
								class="code-group-name" name="codeGroupName" type="text"
								th:value="${commonCode.codeGroupName}"></td>
							<td th:text="${commonCode.codeDetailCount}"></td>
							<td><select>
									<option th:value="Y" th:text="Y"
										th:selected="${commonCode.useYn == 'Y'}"></option>
									<option th:value="N" th:text="N"
										th:selected="${commonCode.useYn == 'N'}"></option>
							</select></td>
							<td><input type="button" value="ì¡°íšŒ" th:data-code-group-id="${commonCode.codeGroupId}"></td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
		<div class="container commoncodedetail-container">
			<h1>ìƒì„¸ ì½”ë“œ</h1>
			<div class="common-btn-container">
				<input id="searchCommonCodeDetailBtn" type="button" value="ì¡°íšŒ">
				<input id="commonCodeDetailSaveBtn" type="button" value="ì €ì¥">
			</div>
			<div class="search-info-container">
				<div class="search-detail-info">
					<span>ì‚¬ìš© ì—¬ë¶€</span> <select id="commonCodeDetailUseYn">
						<option value="A" selected>ì „ì²´</option>
						<option value="Y">Y</option>
						<option value="N">N</option>
					</select> <span>ìƒì„¸ ì½”ë“œ ê·¸ë£¹</span> <input name="commonCodeDetailKeyword"
						type="text" placeholder="ID ë° ê·¸ë£¹ëª…">
				</div>
			</div>
			<div class="row-btn">
				<input id="commonCodeDetailAddRowBtn" type="button" value="í–‰ì¶”ê°€">
				<input id="commonCodeDetailDeleteRowBtn" type="button" value="í–‰ì‚­ì œ">
			</div>
			<div class="table-container commoncodedetail-table-container">
				<table class="table table-striped commoncodedetail-table">
					<thead class="fixed-header">
						<tr>
							<th>ìƒíƒœ</th>
							<th>ì„ íƒ</th>
							<th>ì½”ë“œ ê·¸ë£¹ ID</th>
							<th>ìƒì„¸ ì½”ë“œ ID</th>
							<th>ìƒì„¸ ì½”ë“œëª…</th>
							<th>ì‚¬ìš© ì—¬ë¶€</th>
						</tr>
					</thead>
					<tbody id="commonCodeDetail-table-body">
						<tr>
							<td colspan="6" style="text-align:center; font-weight: bold;">ê³µí†µ ì½”ë“œë¥¼ ì¡°íšŒí•˜ì„¸ìš”.</td>
						</tr>
						<!-- <tr th:each="commonCodeDetail, i : ${commonCodeDetail}">
									<td th:text="${commonCodeDetail.flag}"></td>
									<td><input class="detailCheck" type="checkbox" name="detailCheck"></td>
									<td class="detailCodeGroupId" th:text="${commonCodeDetail.codeGroupId}"></td>
									<td><input type="text" name="detailCode" th:value="${commonCodeDetail.detailCode}"></td>
									<td><input type="text" name="detailCodeName" th:value="${commonCodeDetail.detailCodeName}"></td>
									<td>
									<select>
										<option th:value="${commonCodeDetail.useYn}" th:text="${commonCodeDetail.useYn}"></option>
										<option value="N">N</option>
									</select>
									</td>
								</tr> -->
					</tbody>
				</table>
			</div>
		</div>
	</div>
	</main>
	<script th:inline="javascript">
		$(document)
				.ready(
						function() {
							var commonCode = `[[${commonCode}]]`;
							var commonCodeDetail = `[[${commonCodeDetail}]]`;

							var commonCodeList = JSON.parse(commonCode); // Object Type
							var commonCodeDetail = JSON.parse(commonCodeDetail);
							//console.log(commonCodeList[0]);

							// ê³µí†µ ì½”ë“œ í–‰ ì¶”ê°€ ë²„íŠ¼
							$("#commonCodeAddRowBtn").click(() => {
								const resultText = $("#commonCode-table-body tr>td").text();
								if(resultText.startsWith("ê²€ìƒ‰")) {
									removeCommonCodeRow();
								}
								// ìƒˆë¡œìš´ í–‰ ìƒì„±
								var newRow = $("<tr>");
								var status = $("<td>").text("C");
								var codeGroupId = $("<td>").addClass("code-group-td").append($("<input>").attr({
									type: "text",
									name: "codeGroupId",
									class: "codeGroupId code-group-id code-group-id-input",
									maxlength: "6",
									pattern: "^[a-zA-Z0-9]+$"
								}));
								var codeGroupName = $("<td>").append($("<input>").attr({
										type: "text",
										name: "codeGroupName",
										class: "codeGroupName code-group-name"
								}));
								var codeDetailCount = $("<td>").text("-");
								var useYn = $("<td>").append("<select><option>Y</option><option>N</option></select>");
								var searchDetail = $("<td>").text("-");
								
								newRow.append(status);
								newRow.append(codeGroupId);
								newRow.append(codeGroupName);
								newRow.append(codeDetailCount);
								newRow.append(useYn);
								newRow.append(searchDetail);

								// í…Œì´ë¸”ì— ìƒˆë¡œìš´ í–‰ ì¶”ê°€
								$(".commoncode-table tbody").append(newRow);

								// í–‰ ì¶”ê°€ ì‹œ ìŠ¤í¬ë¡¤ ë§¨ ì•„ë˜
								var tableContainer = $(".commoncode-table-container");
								tableContainer.scrollTop(tableContainer[0].scrollHeight);
							});

							// ê³µí†µ ì½”ë“œ í–‰ì‚­ì œ ë²„íŠ¼
							$("#commonCodeDeleteRowBtn").click(() => {
								var commonCodeTable = $(".commoncode-table tbody");
								var lastRow = commonCodeTable.find("tr:last");
								const codeGroupId = lastRow.find("#commonCode-group-id").text();
								console.log(codeGroupId);

								$.ajax({
									method : "GET",
									url : "/checkcodegroup?codeGroupId=" + codeGroupId,
									success : function(response) {
										if (response > 0) {
											alert("ì´ ì½”ë“œ ê·¸ë£¹ì€ DBì— ì¡´ì¬í•©ë‹ˆë‹¤. ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
											return;
										} else {
											// ì½”ë“œ ê·¸ë£¹ì´ DBì— ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ í•´ë‹¹ í–‰ì„ ì‚­ì œí•©ë‹ˆë‹¤.
											lastRow.remove();
										}
									},
									error : function(xhr,status,error) {
										alert("ì—ëŸ¬ ë°œìƒ:", error);
									}
								});
							});
							
							// Flag ë³€ê²½í•˜ëŠ” í•¨ìˆ˜
							function updateFlag(tableRow){
								var changedRow = $(tableRow).closest("tr"); // ë³€ê²½ëœ ì…ë ¥ í•„ë“œë¥¼ í¬í•¨í•˜ëŠ” í–‰ ê°€ì ¸ì˜¤ê¸°
								var flag = changedRow.find("td:first").text();
								if(flag === "C"){
									return;
								}
								// ë³€ê²½ ìƒíƒœë¥¼ í‘œì‹œ (ì˜ˆ: C = Created, U = Updated)
								changedRow.find("td:first").text("U");
							}
							
							// ê³µí†µ ì½”ë“œ í–‰ ë‚´ì˜ ì…ë ¥ í•„ë“œì— ëŒ€í•œ change ì´ë²¤íŠ¸ ì²˜ë¦¬
							$(".commoncode-table-container").on("change", "input[type='text'], select", function(){
								updateFlag(this);
							});
							
							// ê³µí†µ ì½”ë“œ ê²€ìƒ‰ 
							$("#searchCommonCodeBtn").click(() => {
								var useYn = $("#commonCodeUseYn option:selected").val();
								var keyword = $("input[name='commonCodeKeyword']").val();
								$.ajax({
									method: "GET",
									url : "/search/commoncode",
									data : {
										useYn: useYn,
										keyword: keyword
									},
									success : function(response) {
										$("input[name='commonCodeKeyword']").val("");
										updateCommonCode(response);
									},
									error : function(xhr,status,error) {
										alert("ì—ëŸ¬ ë°œìƒ:", error);
									}
								});
							});
							
							function removeCommonCodeRow(){
								const commonCodeTable = $("#commonCode-table-body tr");
								commonCodeTable.remove();
							}
							
							// ê³µí†µ ì½”ë“œ í…Œì´ë¸” ì—…ë°ì´íŠ¸ í•¨ìˆ˜
							function updateCommonCode(response){
								const resultText = $("#commonCode-table-body tr>td").text();
								removeCommonCodeRow();
								
								if(response.length < 1){
									const result = "<tr>" + "<td colspan='6' style='text-align:center; font-weight: bold;'>" 
			                		+ "ê²€ìƒ‰ëœ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤." + "</td>" + "</tr>";
									$("#commonCode-table-body").append(result);
									return;
								}
								
								for(var i=0; i<response.length; i++){
									var newRow = $("<tr>");
									var status = $("<td>").addClass("flag").text(response[i].flag);
									var codeGroupId = $("<td>").addClass("codeGroupId code-group-id-text code-group-td")
										.text(response[i].codeGroupId)
										.attr("data-code-group-id", response[i].codeGroupId)
										.attr("id", "commonCode-group-id");
									
									var codeGroupName = $("<td>").append($("<input>").attr({
										type: "text",
										name: "codeGroupName",
										value: response[i].codeGroupName,
										class: "codeGroupName code-group-name"
									}));
									var codeDetailCount = $("<td>").addClass("codeDetailCount").text(response[i].codeDetailCount);

									var selectElement = $("<select><option>Y</option><option>N</option></select>");
									selectElement.val(response[i].useYn);
									
									var useYn = $("<td>").append(selectElement);
									var searchDetailCode = $("<td>").append($("<input>").attr({
										type: "button",
										name: "codeGroupId",
										"data-code-group-id": response[i].codeGroupId,
										value: "ì¡°íšŒ",
										class: "code-group-id"
									}))
									
									newRow.append(status);
									newRow.append(codeGroupId);
									newRow.append(codeGroupName);
									newRow.append(codeDetailCount);
									newRow.append(useYn);
									newRow.append(searchDetailCode);

									$(".commoncode-table tbody").append(newRow);
								}
							}
							
							// ì´ë²¤íŠ¸ ìœ„ì„
							// ìƒì„¸ ì½”ë“œ ì¡°íšŒ
							$(".commoncode-table-container").on("click","input[type='button']", function() {
							    var codeGroupId = $(this).data("code-group-id");
							    console.log(codeGroupId);
							    $.ajax({
							    	method: "GET",
							    	url : "/commoncodedetail",
							    	data : {
							    		codeGroupId : codeGroupId
							    	},
							    	success : function(response){
							    		updateCommonCodeDetail(response);
							    	},
							    	error : function(xhr, status, error){
							    		alert("ì—ëŸ¬ ë°œìƒ:", error);
							    	}
							    })
							});
							
							function lengthCheck(word){
								if(word.length === 6){
									return true;
								}
								return false;
							}
							
							// ê³µí†µ ì½”ë“œ ì €ì¥ ë²„íŠ¼
							$("#commonCodeSaveBtn").click(() => {
								var commonCodeList = [];
								var shouldContinue = true;
								
								$("#commonCode-table-body tr").each(function(){
									if (!shouldContinue) {
							            return false; // ë°˜ë³µ ì¢…ë£Œ
							        }
									
									var flag = $(this).find("td:first").text();
									var codeGroupId;
									var codeGroupName;

									if (flag === 'C') {
									    codeGroupId = $(this).find("input[name='codeGroupId']").val();
									    var pattern = /^[A-Z]{3}[0-9]{3}$/;
									    console.log(codeGroupId);
									    console.log(pattern.test(codeGroupId));
									    if(!pattern.test(codeGroupId)){
									    	alert(`${codeGroupId}ë¥¼ ì˜ì–´[ëŒ€ë¬¸ì]ì™€ ìˆ«ì 6ìë¦¬ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
									    	shouldContinue = false;
									    	return false;
									    }
									    if (codeGroupId.length > 6 || codeGroupId.length < 6) {
							                alert("ì½”ë“œ ê·¸ë£¹ IDë¥¼ ì •í™•íˆ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
							                shouldContinue = false; 
							                return false;
							            }
									    codeGroupName = $(this).find("input[name='codeGroupName']").val();
									    if(codeGroupName.length < 1){
									    	alert("ì½”ë“œ ê·¸ë£¹ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");
									    	shouldContinue = false;
									    	return false;
									    }
									}else if(flag === 'U' || flag === 'D'){
									    codeGroupId = $(this).find("td:eq(1)").text(); 
									    codeGroupName = $(this).find("input[name='codeGroupName']").val(); 
									}else{ 
										return;
									}
										var useYn = $(this).find("select option:selected").val();
										console.log(codeGroupName);
										var commonCode = {
												flag: flag,
												codeGroupId: codeGroupId,
												codeGroupName: codeGroupName,
												useYn: useYn
										};
										commonCodeList.push(commonCode);
									});
								if (!shouldContinue) {
							        return;
							    }
								
								if(commonCodeList.length < 1){
									alert("ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
									return ;
								}
								
								$.ajax({
									method: "POST",
									url : "/commoncode",
									data: JSON.stringify(commonCodeList),
									contentType: "application/json",
									success : function(response){
										updateCommonCode(response.commonCode);
										alert("ì„±ê³µ");
									},
									error : function(xhr,status,error) {
										alert("ì—ëŸ¬ ë°œìƒ:", error);
									}
								});
								
							});
							
							function removeCommonCodeDetailRow(){
								const commonCodeDetailTable = $("#commonCodeDetail-table-body tr");
								commonCodeDetailTable.remove();
							}
							
							// ìƒì„¸ ì½”ë“œ í–‰ ì¶”ê°€ ë²„íŠ¼
							$("#commonCodeDetailAddRowBtn").click(() => {
								const resultText = $("#commonCodeDetail-table-body tr>td").text();
								if(resultText.startsWith("ê²€ìƒ‰")){
									removeCommonCodeDetailRow();
								}
								console.log($("#commonCodeDetail-table-body td:first").attr("colspan"));
								const colspan = $("#commonCodeDetail-table-body td:first").attr("colspan");
								if(colspan === "6"){
									$("#commonCodeDetail-table-body tr").remove();
									console.log("A");
								}
								// ìƒˆë¡œìš´ í–‰ ìƒì„±
								var newRow = $("<tr>");
								var status = $("<td>").text("C");
								var select = $("<td>").append($("<input>").attr({
									type : "checkbox",
									name : "detailCheck",
									class : "detailCheck"
								}));
								var detailCodeGroupId = $("<td>").append($("<input>").attr({
									type : "text",
									name : "detailCodeGroupId",
									class : "detailCodeGroupId",
									maxlength: "6",
									pattern: "^[a-zA-Z0-9]+$"
								}));
								var detailCode = $("<td>").append($("<input>").attr({
									type : "text",
									name : "detailCode",
									class : "detailCode",
									maxlength: "6",
									pattern: "^[a-zA-Z0-9]+$"
								}));
								var detailCodeName = $("<td>").append($("<input>").attr({
									type : "text",
									name : "detailCodeName",
									class : "detailCodeName"
								}));
								var useYn = $("<td>").append("<select><option>Y</option><option>N</option></select>");
								
								newRow.append(status);
								newRow.append(select);
								newRow.append(detailCodeGroupId);
								newRow.append(detailCode);
								newRow.append(detailCodeName);
								newRow.append(useYn);
								
								$(".commoncodedetail-table tbody").append(newRow);
								
								var tableContainer = $(".commoncodedetail-table-container");
								tableContainer.scrollTop(tableContainer[0].scrollHeight);
							})

							// ìƒì„¸ ì½”ë“œ í–‰ ì‚­ì œ ë²„íŠ¼
							$("#commonCodeDetailDeleteRowBtn").click(() => {
								var commonCodeTable = $(".commoncodedetail-table");
								var selectedRows = $("input[name='detailCheck']:checked").closest("tr"); // ì„ íƒëœ ì²´í¬ë°•ìŠ¤ì˜ ë¶€ëª¨ í–‰ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
								
							    if (selectedRows.length === 0) {
							        alert("ì‚­ì œí•  í–‰ì„ ì„ íƒí•˜ì„¸ìš”.");
							        return;
							    }
								
								var updateCount = 0;
								var deleteCount = 0;
								var deleteText = "";
							    // ì„ íƒëœ ê° í–‰ì— ëŒ€í•´ ì²˜ë¦¬
							    selectedRows.each(function() {
							        var selectedRow = $(this);
							        var flag = selectedRow.find("td:first").text();
							        var deleteStatus = selectedRow.find("select").val();
							        if(deleteStatus === 'N' && flag === 'E'){
							        	const codeGroupId = selectedRow.find("input[type='text']").val();
							        	deleteCount++;
							        	selectedRow.find("input[type='checkbox']").prop("checked", false);
							        	deleteText += `ìƒì„¸ ì½”ë“œ ${codeGroupId}ëŠ” ì´ë¯¸ ì‚¬ìš©ì—¬ë¶€ê°€ N ì…ë‹ˆë‹¤.\n`;
							        	return;	
							        }
							        // ì„ íƒëœ í–‰ì„ ë‘ë²ˆ ëˆ„ë¥¼ ê²½ìš° checkedë˜ ìˆëŠ” ìƒíƒœì´ê¸° ë•Œë¬¸ì— ì„ íƒí•œ í–‰ì´ ì‚­ì œë˜ì—ˆë‹¤ê³  ëœ¨ëŠ” ê²ƒì„ ë§‰ê¸° ìœ„í•´
							        selectedRow.find("input[name='detailCheck']").prop("checked", false);

							        if (flag === "C") {
							            // CreateëŠ” ë°˜ì˜í•˜ì§€ ì•Šìœ¼ë©´ ë˜ë¯€ë¡œ ê·¸ëƒ¥ í–‰ ì‚­ì œ
							            selectedRow.remove();
							        } else {
							            // í–‰ì˜ flagë¥¼ "D"ë¡œ ë³€ê²½
							            selectedRow.find("td:first").text("D");
							            selectedRow.find("input[type='text']").prop("disabled", true);
							            selectedRow.find("select").prop("disabled", true);
							            selectedRow.find("input[type='checkbox']").prop("disabled", true);
							            
							            const codeGroupId = selectedRow.find("input[type='text']").val();
							            updateCount++;
							            deleteText += `ìƒì„¸ ì½”ë“œ ${codeGroupId}ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.\n`;
							        }
							    });
							    if(deleteCount > 0 || updateCount > 0){
							    	alert(`${deleteText}`);
							    }
							    return;
							})
							
							// ìƒì„¸ ì½”ë“œ í–‰ ë‚´ì˜ ì…ë ¥ í•„ë“œì— ëŒ€í•œ change ì´ë²¤íŠ¸ ì²˜ë¦¬
							$(".commoncodedetail-table-container").on("change", "input[type='text'], select", function(){
								updateFlag(this);
							});
							
							// ìƒì„¸ ì½”ë“œ ê²€ìƒ‰
							$("#searchCommonCodeDetailBtn").click(() => {
								var useYn = $("#commonCodeDetailUseYn option:selected").val();
								var keyword = $("input[name='commonCodeDetailKeyword']").val();
								console.log(useYn);
								$.ajax({
									method: "GET",
									url : "/search/commoncodedetail",
									data : {
										useYn: useYn,
										keyword: keyword
									},
									success : function(response) {
										$("input[name='commonCodeDetailKeyword']").val("");
										updateCommonCodeDetail(response);
									},
									error : function(xhr,status,error) {
										alert("ì—ëŸ¬ ë°œìƒ:", error);
									}
								});
							});
							
							// ìƒì„¸ ì½”ë“œ ì €ì¥ ë²„íŠ¼
							$("#commonCodeDetailSaveBtn").click(() => {
								var commonCodeDetailList = [];
								var shouldContinue = true;
								console.log($("#commonCodeDetail-table-body tr"));
								$("#commonCodeDetail-table-body tr").each(function(){
									console.log("SHOULDCONTINUDE: " + shouldContinue);
									if (!shouldContinue) {
										console.log("?:",shouldContinue);
							            return false; // ë°˜ë³µ ì¢…ë£Œ
							        }
									
									var flag = $(this).find("td:first").text();
									var detailCodeGroupId;
									var detailCode;
									if(flag == 'U' || flag == 'D'){
										detailCodeGroupId = $(this).find("td:eq(2)").text();
										detailCode = $(this).find("td:eq(3)").text();
										
										var pattern = /^[A-Z]{3}[0-9]{3}$/;
									    if(!pattern.test(detailCodeGroupId)){
									    	alert(`ì½”ë“œ ê·¸ë£¹ ID :${detailCodeGroupId} \nì •í™•í•œ ì½”ë“œ ê·¸ë£¹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
									    	shouldContinue = false;
									    	return false;
									    }
									    
									    if (detailCode.length > 6 || detailCode.length < 6) {
							                alert(`${detailCode}: ìƒì„¸ ì½”ë“œë¥¼ ì •í™•íˆ ì…ë ¥í•´ ì£¼ì„¸ìš”.`);
							                shouldContinue = false; 
							                return false;
							            }
									    
									    if(!pattern.test(detailCode)){
									    	alert(`${detailCode}ë¥¼ ì˜ì–´[ëŒ€ë¬¸ì]ì™€ ìˆ«ì 6ìë¦¬ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
									    	shouldContinue = false;
									    	return false;
									    }
									}else if(flag == 'C'){
										detailCodeGroupId = $(this).find("input[name='detailCodeGroupId']").val();
										detailCode = $(this).find("input[name='detailCode']").val();
										console.log("detailCode: ",detailCode);
										var pattern = /^[A-Z]{3}[0-9]{3}$/;
									    if(!pattern.test(detailCodeGroupId)){
									    	alert(`ì½”ë“œ ê·¸ë£¹ ID :${detailCodeGroupId} \nì •í™•í•œ ì½”ë“œ ê·¸ë£¹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
									    	shouldContinue = false;
									    	return false;
									    }
									    
									    if (detailCode.length > 6 || detailCode.length < 6) {
							                alert(`${detailCode}: ìƒì„¸ ì½”ë“œë¥¼ ì˜ì–´[ëŒ€ë¬¸ì]ì™€ ìˆ«ì 6ìë¦¬ë¡œ ì…ë ¥í•˜ì„¸ìš”.`);
							                shouldContinue = false; 
							                return false;
							            }
									    
									    if(!pattern.test(detailCode)){
									    	alert(`${detailCode}: ìƒì„¸ ì½”ë“œë¥¼ ì˜ì–´[ëŒ€ë¬¸ì]ì™€ ìˆ«ì 6ìë¦¬ë¡œ ì…ë ¥í•˜ì„¸ìš”.`);
									    	shouldContinue = false;
									    	return false;
									    }
									}
									var detailCodeName = $(this).find("input[name='detailCodeName']").val();
									
									if(detailCodeName === undefined || detailCodeName === ""){
										alert("ìƒì„¸ ì½”ë“œëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");
										shouldContinue = false;
										return false;
									}
									var useYn = $(this).find("select option:selected").val();

									var commonCodeDetail = {
											flag: flag,
											codeGroupId: detailCodeGroupId,
											detailCode: detailCode,
											detailCodeName: detailCodeName,
											useYn: useYn
									}
									if(flag !== 'E'){
									 	commonCodeDetailList.push(commonCodeDetail);
									}
								});
								console.log(shouldContinue);
								if(!shouldContinue){
									return;
								}
								if(commonCodeDetailList.length < 1){
									return ;
								}
								
								console.log(commonCodeDetailList);
								$.ajax({
									method: "POST",
									url: "/commoncodedetail",
									data: JSON.stringify(commonCodeDetailList),
									contentType: "application/json",
									success : function(response){
										console.log(response);
										if(response.code === 400){
											alert(`${response.message}`);
											return;
										}
										updateCommonCode(response.data.commonCode);
										updateCommonCodeDetail(response.data.commonCodeDetail);
										alert("ì„±ê³µ");
									},
									error : function(xhr,status,error) {
										alert("ì—ëŸ¬ ë°œìƒ:", error);
									}
								});
							});
							
							function removeCommonCodeDetailRow(){
								const commonCodeDetailTable = $("#commonCodeDetail-table-body tr");
								commonCodeDetailTable.remove();
							}
							
							// ìƒì„¸ ì½”ë“œ í…Œì´ë¸” ì—…ë°ì´íŠ¸ í•¨ìˆ˜
							function updateCommonCodeDetail(response){
								removeCommonCodeDetailRow();
								
								if(response.length < 1){
									const result = "<tr>" + "<td colspan='6' style='text-align:center; font-weight: bold;'>" 
			                		+ "ê²€ìƒ‰ëœ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤." + "</td>" + "</tr>";
									$("#commonCodeDetail-table-body").append(result);
									return;
								}
								
								for (var i = 0; i < response.length; i++) {
									var newRow = $("<tr>");
									var status = $("<td>").text(response[i].flag);
									var select = $("<td>").append($("<input>").attr({
									    type: "checkbox",
									    name: "detailCheck",
									    class: "detailCheck"
									  }));
									var detailCodeGroupId = $("<td>").text(response[i].codeGroupId).attr({
										name: "detailCodeGroupId",
										class: "detailCodeGroupId detail-code-group-id"
									});
									var detailCode = $("<td>").text(response[i].detailCode).attr({
										name: "detailCode",
										class: "detailCode"
									});
									var detailCodeName = $("<td>").append($("<input>").attr({
										type: "text",
										name: "detailCodeName",
										value: response[i].detailCodeName,
										class: "detailCodeName"
									}));
									var selectElement = $("<select><option>Y</option><option>N</option></select>");
									selectElement.val(response[i].useYn);
									var useYn = $("<td>").append(selectElement);
									
									newRow.append(status);
									newRow.append(select);
									newRow.append(detailCodeGroupId);
									newRow.append(detailCode);
									newRow.append(detailCodeName);
									newRow.append(useYn);
									$(".commoncodedetail-table tbody").append(newRow);
								}
							}
				});
	</script>
	<script th:src="@{/assets/js/main.js}"></script>
</html>